---
layout: post
title: å‰ç«¯ç»„ä»¶åŒ–ï¼ˆäºŒï¼‰ï¼šä¼˜åŒ– DOM æ“ä½œ
description: React.js å°ä¹¦æ˜¯ä¸€ä¸ªå¼€æºã€å…è´¹ã€ä¸“ä¸šã€ç®€å•çš„ React.js æ•™ç¨‹ã€‚æœ¬æ–‡æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•ä½¿ç”¨ React.js å®ç°å‰ç«¯ç»„ä»¶åŒ–çš„æ•™ç¨‹çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä»‹ç»äº†å¦‚ä½•ä¼˜åŒ–è™šæ‹Ÿ DOMã€‚
tags: [React.js,React.js å°ä¹¦,æ•™ç¨‹,ç»„ä»¶,è™šæ‹Ÿ DOM]
---

<ul style='font-size: 14px; margin-top: -10px;'>
  <li>
    ä½œè€…ï¼š<a href="https://www.zhihu.com/people/hu-zi-da-ha" target="_blank">èƒ¡å­å¤§å“ˆ</a>
  </li>
  <li>
    åŸæ–‡é“¾æ¥ï¼š<a href="http://huziketang.com/books/react{{ page.url }}"> http://huziketang.com/books/react{{ page.url }} </a>
  </li>
  <li>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œä¿ç•™åŸæ–‡é“¾æ¥å’Œä½œè€…ä¿¡æ¯ã€‚</li>
</ul>

çœ‹çœ‹ä¸Šä¸€èŠ‚æˆ‘ä»¬çš„ä»£ç ï¼Œä»”ç»†ç•™æ„ä¸€ä¸‹ `changeLikeText` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åŒ…å«äº† DOM æ“ä½œï¼Œç°åœ¨çœ‹èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œé‚£æ˜¯å› ä¸ºç°åœ¨åªæœ‰ `isLiked` ä¸€ä¸ªçŠ¶æ€ã€‚ç”±äºæ•°æ®çŠ¶æ€æ”¹å˜ä¼šå¯¼è‡´éœ€è¦æˆ‘ä»¬å»æ›´æ–°é¡µé¢çš„å†…å®¹ï¼Œæ‰€ä»¥å‡æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ çš„ç»„ä»¶ä¾èµ–äº†å¾ˆå¤šçŠ¶æ€ï¼Œé‚£ä¹ˆä½ çš„ç»„ä»¶åŸºæœ¬å…¨éƒ¨éƒ½æ˜¯ DOM æ“ä½œã€‚

ä¸€ä¸ªç»„ä»¶çš„æ˜¾ç¤ºå½¢æ€ç”±å¤šä¸ªçŠ¶æ€å†³å®šçš„æƒ…å†µéå¸¸å¸¸è§ã€‚ä»£ç ä¸­æ··æ‚ç€å¯¹ DOM çš„æ“ä½œå…¶å®æ˜¯ä¸€ç§ä¸å¥½çš„å®è·µï¼Œæ‰‹åŠ¨ç®¡ç†æ•°æ®å’Œ DOM ä¹‹é—´çš„å…³ç³»ä¼šå¯¼è‡´ä»£ç å¯ç»´æŠ¤æ€§å˜å·®ã€å®¹æ˜“å‡ºé”™ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ä¾‹å­è¿™é‡Œè¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼šå¦‚ä½•å°½é‡å‡å°‘è¿™ç§æ‰‹åŠ¨ DOM æ“ä½œï¼Ÿ

## çŠ¶æ€æ”¹å˜ -> æ„å»ºæ–°çš„ DOM å…ƒç´ æ›´æ–°é¡µé¢
è¿™é‡Œè¦æå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼š*ä¸€æ—¦çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œå°±é‡æ–°è°ƒç”¨  `render`  æ–¹æ³•ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„ DOM å…ƒç´ *ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¥½å¤„å°±æ˜¯ä½ å¯ä»¥åœ¨ `render` æ–¹æ³•é‡Œé¢ä½¿ç”¨æœ€æ–°çš„ `this.state` æ¥æ„é€ ä¸åŒ HTML ç»“æ„çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªå­—ç¬¦ä¸²æ„é€ ä¸åŒçš„ DOM å…ƒç´ ã€‚é¡µé¢å°±æ›´æ–°äº†ï¼å¬èµ·æ¥æœ‰ç‚¹ç»•ï¼Œçœ‹çœ‹ä»£ç æ€ä¹ˆå†™ï¼Œä¿®æ”¹åŸæ¥çš„ä»£ç ä¸ºï¼š

```javascript
  class LikeButton {
    constructor () {
      this.state = { isLiked: false }
    }

    setState (state) {
      this.state = state
      this.el = this.render()
    }

    changeLikeText () {
      this.setState({
        isLiked: !this.state.isLiked
      })
    }

    render () {
      this.el = createDOMFromString(`
        <button class='like-btn'>
          <span class='like-text'>${this.state.isLiked ? 'å–æ¶ˆ' : 'ç‚¹èµ'}</span>
          <span>ğŸ‘</span>
        </button>
      `)
      this.el.addEventListener('click', this.changeLikeText.bind(this), false)
      return this.el
    }
  }
```

å…¶å®åªæ˜¯æ”¹äº†å‡ ä¸ªå°åœ°æ–¹ï¼š

1. `render` å‡½æ•°é‡Œé¢çš„ HTML å­—ç¬¦ä¸²ä¼šæ ¹æ® `this.state` ä¸åŒè€Œä¸åŒï¼ˆè¿™é‡Œæ˜¯ç”¨äº† ES6 çš„æ¨¡ç‰ˆå­—ç¬¦ä¸²ï¼Œåšè¿™ç§äº‹æƒ…å¾ˆæ–¹ä¾¿ï¼‰ã€‚
2. æ–°å¢ä¸€ä¸ª `setState` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼›å®ƒä¼šè®¾ç½®å®ä¾‹çš„ `state`ï¼Œç„¶åé‡æ–°è°ƒç”¨ä¸€ä¸‹ `render` æ–¹æ³•ã€‚
3. å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œ `changeLikeText`  ä¼šæ„å»ºæ–°çš„ `state` å¯¹è±¡ï¼Œè¿™ä¸ªæ–°çš„ `state` ï¼Œä¼ å…¥ `setState` å‡½æ•°å½“ä¸­ã€‚

è¿™æ ·çš„ç»“æœå°±æ˜¯ï¼Œç”¨æˆ·æ¯æ¬¡ç‚¹å‡»ï¼Œ`changeLikeText` éƒ½ä¼šè°ƒç”¨æ”¹å˜ç»„ä»¶çŠ¶æ€ç„¶åè°ƒç”¨ `setState` ï¼›`setState` ä¼šè°ƒç”¨ `render` ï¼Œ`render` æ–¹æ³•ä¼šæ ¹æ®  `state` çš„ä¸åŒé‡æ–°æ„å»ºä¸åŒçš„ DOM å…ƒç´ ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ*ä½ åªè¦è°ƒç”¨ `setState`ï¼Œç»„ä»¶å°±ä¼šé‡æ–°æ¸²æŸ“*ã€‚æˆ‘ä»¬é¡ºåˆ©åœ°æ¶ˆé™¤äº†æ‰‹åŠ¨çš„ DOM æ“ä½œã€‚

## é‡æ–°æ’å…¥æ–°çš„ DOM å…ƒç´ 
ä¸Šé¢çš„æ”¹è¿›ä¸ä¼šæœ‰ä»€ä¹ˆæ•ˆæœï¼Œå› ä¸ºä½ ä»”ç»†çœ‹ä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œå…¶å®é‡æ–°æ¸²æŸ“çš„ DOM å…ƒç´ å¹¶æ²¡æœ‰æ’å…¥åˆ°é¡µé¢å½“ä¸­ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªç»„ä»¶å¤–é¢ï¼Œä½ éœ€è¦çŸ¥é“è¿™ä¸ªç»„ä»¶å‘ç”Ÿäº†æ”¹å˜ï¼Œå¹¶ä¸”æŠŠæ–°çš„ DOM å…ƒç´ æ›´æ–°åˆ°é¡µé¢å½“ä¸­ã€‚

é‡æ–°ä¿®æ”¹ä¸€ä¸‹ `setState` æ–¹æ³•ï¼š

```javascript
...
    setState (state) {
      const oldEl = this.el
      this.state = state
      this.el = this.render()
      if (this.onStateChange) this.onStateChange(oldEl, this.el)
    }
...
```

ä½¿ç”¨è¿™ä¸ªç»„ä»¶çš„æ—¶å€™ï¼š

```javascript
const likeButton = new LikeButton()
wrapper.appendChild(likeButton.render()) // ç¬¬ä¸€æ¬¡æ’å…¥ DOM å…ƒç´ 
likeButton.onStateChange = (oldEl, newEl) => {
  wrapper.insertBefore(newEl, oldEl) // æ’å…¥æ–°çš„å…ƒç´ 
  wrapper.removeChild(oldEl) // åˆ é™¤æ—§çš„å…ƒç´ 
}
```

è¿™é‡Œæ¯æ¬¡ `setState` éƒ½ä¼šè°ƒç”¨ `onStateChange` æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æ˜¯å®ä¾‹åŒ–ä»¥åæ—¶å€™è¢«è®¾ç½®çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥è‡ªå®šä¹‰ `onStateChange` çš„è¡Œä¸ºã€‚*è¿™é‡Œåšçš„äº‹æ˜¯ï¼Œæ¯å½“ `setState` ä¸­æ„é€ å®Œæ–°çš„ DOM å…ƒç´ ä»¥åï¼Œå°±ä¼šé€šè¿‡ `onStateChange` å‘ŠçŸ¥å¤–éƒ¨æ’å…¥æ–°çš„ DOM å…ƒç´ ï¼Œç„¶ååˆ é™¤æ—§çš„å…ƒç´ ï¼Œé¡µé¢å°±æ›´æ–°äº†*ã€‚è¿™é‡Œå·²ç»åšåˆ°äº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–äº†ï¼šç°åœ¨ä¸éœ€è¦å†æ‰‹åŠ¨æ›´æ–°é¡µé¢äº†ã€‚

éä¸€èˆ¬çš„æš´åŠ›ï¼Œå› ä¸ºæ¯æ¬¡ `setState` éƒ½é‡æ–°æ„é€ ã€æ–°å¢ã€åˆ é™¤ DOM å…ƒç´ ï¼Œä¼šå¯¼è‡´æµè§ˆå™¨è¿›è¡Œå¤§é‡çš„é‡æ’ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚ä¸è¿‡æ²¡æœ‰å…³ç³»ï¼Œè¿™ç§æš´åŠ›è¡Œä¸ºå¯ä»¥è¢«ä¸€ç§å« Virtual-DOM çš„ç­–ç•¥è§„é¿æ‰ï¼Œä½†è¿™ä¸æ˜¯æœ¬æ–‡æ‰€è®¨è®ºçš„èŒƒå›´ã€‚

è¿™ä¸ªç‰ˆæœ¬çš„ç‚¹èµåŠŸèƒ½å¾ˆä¸é”™ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¾€ä¸Šé¢åŠ åŠŸèƒ½ï¼Œè€Œä¸”è¿˜ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œDOMã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹ï¼Œå¦‚æœæˆ‘è¦é‡æ–°å¦å¤–åšä¸€ä¸ªæ–°ç»„ä»¶ï¼Œè­¬å¦‚è¯´è¯„è®ºç»„ä»¶ï¼Œé‚£ä¹ˆé‡Œé¢çš„è¿™äº› `setState` æ–¹æ³•è¦é‡æ–°å†™ä¸€éï¼Œå…¶å®è¿™äº›ä¸œè¥¿éƒ½å¯ä»¥æŠ½å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ªé€šç”¨çš„æ¨¡å¼ã€‚[ä¸‹ä¸€èŠ‚](http://huziketang.com/books/react/lesson4)æˆ‘ä»¬æŠŠè¿™ä¸ªé€šç”¨æ¨¡å¼æŠ½ç¦»åˆ°ä¸€ä¸ªç±»å½“ä¸­ã€‚

* * *

> å› ä¸ºç¬¬ä¸‰æ–¹è¯„è®ºå·¥å…·æœ‰é—®é¢˜ï¼Œå¯¹æœ¬ç« èŠ‚æœ‰ä»»ä½•ç–‘é—®çš„æœ‹å‹å¯ä»¥ç§»æ­¥åˆ° <a target="_blank" href="http://scriptoj.com/category/4/react-js-å°ä¹¦äº¤æµåŒº">React.js å°ä¹¦çš„è®ºå›</a> å‘å¸–ï¼Œæˆ‘ä¼šå›ç­”å¤§å®¶çš„ç–‘é—®ã€‚
